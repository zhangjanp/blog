<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>ä»¥ä¸€ä¸ªğŸŒ°æ¢³ç†Vue æ›´æ–°æµç¨‹ | Janp</title>
    <meta name="description" content="ä»¥ä¸€ä¸ªä¾‹å­å¯¹Vue åˆå§‹åŒ–åˆ°æ›´æ–°çš„æ•´ä½“æµç¨‹è¿›è¡Œæ¢³ç†ï¼Œæ‘¸æ¸…Vue å“åº”å¼åŸç†ï¼ŒVue äº‹ä»¶çš„è§¦å‘åŸç†">
    <meta name="generator" content="VuePress 1.3.1">
    
    <meta name="keywords" content="vue æºç åˆ†æ å“åº”å¼åŸç† å‘å¸ƒè®¢é˜…">
    <link rel="preload" href="/blog/assets/css/0.styles.fad705ec.css" as="style"><link rel="preload" href="/blog/assets/js/app.5776ca6d.js" as="script"><link rel="preload" href="/blog/assets/js/7.97f44f77.js" as="script"><link rel="preload" href="/blog/assets/js/4.3aa6202f.js" as="script"><link rel="preload" href="/blog/assets/js/15.b29bc2a4.js" as="script"><link rel="prefetch" href="/blog/assets/js/1.054991ad.js"><link rel="prefetch" href="/blog/assets/js/10.ba60cd24.js"><link rel="prefetch" href="/blog/assets/js/11.f2e04d17.js"><link rel="prefetch" href="/blog/assets/js/12.971777f1.js"><link rel="prefetch" href="/blog/assets/js/13.5e2a11c8.js"><link rel="prefetch" href="/blog/assets/js/14.76ffd939.js"><link rel="prefetch" href="/blog/assets/js/16.69315479.js"><link rel="prefetch" href="/blog/assets/js/17.26d9ffad.js"><link rel="prefetch" href="/blog/assets/js/18.e3e5bcad.js"><link rel="prefetch" href="/blog/assets/js/5.473bc382.js"><link rel="prefetch" href="/blog/assets/js/6.69eb8797.js"><link rel="prefetch" href="/blog/assets/js/8.bdf2ae69.js"><link rel="prefetch" href="/blog/assets/js/9.f8ec58bc.js"><link rel="prefetch" href="/blog/assets/js/vuejs-paginate.5dc0cfdd.js">
    <link rel="stylesheet" href="/blog/assets/css/0.styles.fad705ec.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div id="vuepress-theme-blog__global-layout"><section id="header-wrapper"><header id="header"><div class="header-wrapper"><div class="title"><a href="/blog/" class="nav-link home-link">Janp </a></div> <div class="header-right-wrap"><ul class="nav"><li class="nav-item"><a href="/blog/me.html" class="nav-link">About</a></li><li class="nav-item"><a href="https://github.com/zhangjanp/blog" target="_blank" rel="noopener noreferrer" class="nav-link external">Github</a></li></ul> <div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <!----></div></div></header></section> <div id="mobile-header"><div class="mobile-header-bar"><div class="mobile-header-title"><a href="/blog/" class="nav-link mobile-home-link">Janp </a> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg></div> <div class="mobile-menu-wrapper"><hr class="menu-divider"> <ul class="mobile-nav"><li class="mobile-nav-item"><a href="/blog/me.html" class="nav-link">About</a></li><li class="mobile-nav-item"><a href="https://github.com/zhangjanp/blog" target="_blank" rel="noopener noreferrer" class="nav-link external">Github</a></li> <li class="mobile-nav-item"><!----></li></ul></div></div></div> <div class="content-wrapper"><div id="vuepress-theme-blog__post-layout"><article itemscope="itemscope" itemtype="https://schema.org/BlogPosting" class="vuepress-blog-theme-content"><header><h1 itemprop="name headline" class="post-title">
        ä»¥ä¸€ä¸ªğŸŒ°æ¢³ç†Vue æ›´æ–°æµç¨‹
      </h1> <div class="post-meta"><!----> <div class="post-meta-date"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-clock"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg> <time pubdate itemprop="datePublished" datetime="2020-03-23T00:00:00.000Z">
      2020-03-23
    </time></div> <ul itemprop="keywords" class="post-meta-tags"><li class="post-tag" data-v-d832e844><a href="/blog/tag/Vue" data-v-d832e844> Vue </a></li></ul></div></header> <div itemprop="articleBody" class="content__default"><h4 id="å‰è¨€"><a href="#å‰è¨€" class="header-anchor">#</a> å‰è¨€</h4> <p>Vue å¦‚æ—¥ä¸­å¤©ï¼Œå‡ ä¹æ¯ä¸€ä¸ªWeb å¼€å‘è€…éƒ½çŸ¥é“Vue æ˜¯é€šè¿‡<strong>Object.defineProperty</strong> å¯¹æ•°æ®åŠ«æŒä»¥è¾¾åˆ°å“åº”å¼å¤„ç†ï¼Œé€šè¿‡å‘å¸ƒè®¢é˜…æ¨¡å¼è¿›è¡Œäº‹ä»¶å¤„ç†ï¼Œé€šè¿‡key ç¡®ä¿å…ƒç´ çŠ¶æ€å¤ç”¨...</p> <hr> <p>é’ˆå¯¹è¿™äº›çŸ¥è¯†ç‚¹ï¼Œé€šè¿‡ä¸€ä¸ªä¾‹å­è¿›è¡Œæ¢³ç†ã€‚ä¿—è¯è¯´ï¼Œâ€œå…‰ç»ƒä¸è¯´å‚»æŠŠå¼â€ï¼Œé‚£ä¹ˆè¿›è¡Œä¸€æ¬¡è‡ªæˆ‘æ£€é˜…ã€‚</p> <p>ï¼ˆä»¥ä¸‹å†…å®¹ç»“åˆ<a href="https://github.com/vuejs/vue/tree/v2.6.11" target="_blank" rel="noopener noreferrer">vue v2.6.11<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>é˜…è¯»ï¼‰</p> <div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>app<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>text<span class="token punctuation">&quot;</span></span> <span class="token attr-name">v-model</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>name<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>my-button</span> <span class="token attr-name">text</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>æ·»åŠ <span class="token punctuation">&quot;</span></span> <span class="token attr-name">@click</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>add<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ul</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span> <span class="token attr-name">v-for</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>(item, i) in showList<span class="token punctuation">&quot;</span></span> <span class="token attr-name">:key</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>i<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>checkbox<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span> {{ item.name }}
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ul</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vue</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  el<span class="token operator">:</span> <span class="token string">'#app'</span><span class="token punctuation">,</span>
  components<span class="token operator">:</span> <span class="token punctuation">{</span>
    MyButton<span class="token operator">:</span> <span class="token punctuation">{</span>
      template<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&lt;button @click=&quot;$emit('click')&quot;&gt;{{ text }}&lt;/button&gt;</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
      props<span class="token operator">:</span> <span class="token punctuation">{</span>
        text<span class="token operator">:</span> String<span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  data<span class="token operator">:</span> <span class="token punctuation">{</span>
    name<span class="token operator">:</span> <span class="token string">''</span><span class="token punctuation">,</span>
    newId<span class="token operator">:</span> <span class="token number">3</span><span class="token punctuation">,</span>
    list<span class="token operator">:</span> <span class="token punctuation">[</span>
      Object<span class="token punctuation">.</span><span class="token function">freeze</span><span class="token punctuation">(</span><span class="token punctuation">{</span> id<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span> name<span class="token operator">:</span> <span class="token string">'ææ–¯'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      Object<span class="token punctuation">.</span><span class="token function">freeze</span><span class="token punctuation">(</span><span class="token punctuation">{</span> id<span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span> name<span class="token operator">:</span> <span class="token string">'å•ä¸éŸ¦'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      Object<span class="token punctuation">.</span><span class="token function">freeze</span><span class="token punctuation">(</span><span class="token punctuation">{</span> id<span class="token operator">:</span> <span class="token number">3</span><span class="token punctuation">,</span> name<span class="token operator">:</span> <span class="token string">'å¬´æ”¿'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>

  computed<span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token function">showList</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>list<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token parameter">v</span> <span class="token operator">=&gt;</span> v<span class="token punctuation">.</span>id <span class="token operator">&lt;=</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>

  methods<span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token function">add</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>name<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>

      <span class="token keyword">this</span><span class="token punctuation">.</span>list<span class="token punctuation">.</span><span class="token function">unshift</span><span class="token punctuation">(</span>Object<span class="token punctuation">.</span><span class="token function">freeze</span><span class="token punctuation">(</span><span class="token punctuation">{</span> id<span class="token operator">:</span> <span class="token operator">++</span><span class="token keyword">this</span><span class="token punctuation">.</span>newId<span class="token punctuation">,</span> name<span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><h4 id="åˆå§‹åŒ–"><a href="#åˆå§‹åŒ–" class="header-anchor">#</a> åˆå§‹åŒ–</h4> <p>Vue åœ¨åˆå§‹åŒ–é˜¶æ®µåšäº†æŒºå¤šäº‹æƒ…ï¼Œé…ç½®åˆå¹¶ï¼Œåˆå§‹åŒ–ç”Ÿå‘½å‘¨æœŸç›¸å…³ä¿¡æ¯ï¼Œåˆå§‹åŒ–äº‹ä»¶ä¸­å¿ƒï¼Œåˆå§‹åŒ–dataï¼Œåˆå§‹åŒ–propsï¼Œåˆå§‹åŒ–computedï¼Œåˆå§‹åŒ–watcherã€‚æœ¬æ–‡åªåˆ†æä¾‹å­æ¶‰åŠçš„å…³é”®ç‚¹ã€‚</p> <h5 id="åˆå§‹åŒ–data"><a href="#åˆå§‹åŒ–data" class="header-anchor">#</a> åˆå§‹åŒ–data</h5> <p>åˆå§‹åŒ–data çš„è°ƒç”¨æ ˆ<code>new Observer(value)</code>â†<code>observe</code>â†<code>initData</code></p> <p>æ•°æ®ç›‘å¬çš„è°ƒç”¨æ ˆ<code>defineReactive(obj, keys[i])</code>â†<code>walk(value)</code>â†<code>new Observer(value)</code></p> <p>åœ¨<code>defineReactive</code>å†…è¿˜ä¼šå¯¹å€¼è¿›è¡Œè§‚æµ‹<code>observe(obj[key])</code></p> <p>é€’å½’ä¸‹æ¥ï¼Œå°±èƒ½æ·±åº¦ç›‘å¬dataå¯¹è±¡ã€‚</p> <p>æœ¬æ–‡åªåˆ†ævalue æ˜¯data.listçš„è¿‡ç¨‹ã€‚</p> <p>ç”±äº<strong>Object.defineProperty</strong> ä¸èƒ½å¤Ÿç›‘å¬æ•°ç»„ä¸‹æ ‡ï¼Œæ‰€ä»¥Vue æ˜¯é€šè¿‡hackï¼Œé‡å†™æ‰€æœ‰èƒ½æ”¹å˜æ•°ç»„è‡ªèº«çš„æ–¹æ³•ï¼Œæ¯”å¦‚pushï¼Œpopï¼Œå…ˆæ‰§è¡ŒåŸé€»è¾‘å‡½æ•°ï¼Œå¦‚æœæ˜¯å¾€æ•°ç»„æ–°å¢å…ƒç´ ï¼Œåˆ™æŠŠæ–°å¢å…ƒç´ å˜æˆå“åº”å¼ã€‚</p> <p>å†éå†data.listçš„å…ƒç´ ï¼Œæ‰§è¡Œ<code>new Observer(value)</code>ï¼Œæ­¤æ—¶value ä¸ºæ•°ç»„å…ƒç´ ï¼Œéå†å…ƒç´ å±æ€§ï¼Œæ‰§è¡Œ<code>defineReactive(obj, keys[i])</code>ä¸ºæ¯ä¸€ä¸ªå…ƒç´ çš„å±æ€§æ·»åŠ getter setterï¼Œä¾‹å­ä¸­çš„å…ƒç´ è¢«Object.freeze()å¤„ç†ï¼Œä¸ä¼šå¯¹å­å…ƒç´ å¤„ç†ã€‚</p> <h5 id="åˆå§‹åŒ–computed"><a href="#åˆå§‹åŒ–computed" class="header-anchor">#</a> åˆå§‹åŒ–computed</h5> <p>éå†computed å¯¹è±¡ï¼Œå¯¹æ¯ä¸€ä¸ªcomputed å±æ€§å®ä¾‹åŒ–watcherï¼Œå…¶å®computed å°±æ˜¯computed watcherã€‚</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// https://github.com/vuejs/vue/blob/v2.6.11/src/core/instance/state.js#L187</span>
<span class="token keyword">new</span> <span class="token class-name">Watcher</span><span class="token punctuation">(</span>
  vm<span class="token punctuation">,</span>
  getter <span class="token operator">||</span> noop<span class="token punctuation">,</span>
  noop<span class="token punctuation">,</span>
  computedWatcherOptions <span class="token comment">// { lazy: true }</span>
<span class="token punctuation">)</span>
</code></pre></div><p>é‡æ–°å®šä¹‰computed çš„getter</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// https://github.com/vuejs/vue/blob/v2.6.11/src/core/instance/state.js#L241</span>
<span class="token keyword">function</span> <span class="token function">createComputedGetter</span> <span class="token punctuation">(</span><span class="token parameter">key</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">function</span> <span class="token function">computedGetter</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> watcher <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_computedWatchers <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_computedWatchers<span class="token punctuation">[</span>key<span class="token punctuation">]</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>watcher<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>watcher<span class="token punctuation">.</span>dirty<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        watcher<span class="token punctuation">.</span><span class="token function">evaluate</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>Dep<span class="token punctuation">.</span>target<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        watcher<span class="token punctuation">.</span><span class="token function">depend</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">return</span> watcher<span class="token punctuation">.</span>value
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="æ¸²æŸ“"><a href="#æ¸²æŸ“" class="header-anchor">#</a> æ¸²æŸ“</h4> <p>Vue æœ‰Runtime only ç‰ˆæœ¬å’ŒRuntime + complierç‰ˆæœ¬ã€‚</p> <p>å¯¹äºåŸºäºwebpack çš„å·¥ç¨‹ï¼Œåªéœ€è¦Runtimeï¼Œé€šè¿‡vue-loader å’Œvue-template-compiler å°†template é¢„ç¼–è¯‘ä¸ºæ¸²æŸ“å‡½æ•°ï¼Œé¿å…è¿è¡Œæ—¶ç¼–è¯‘å¼€é”€ã€‚</p> <p>ç¼–è¯‘è°ƒç”¨æ ˆ<code>generate</code>â†<code>createFunction</code>â†<code>compileToFunctions</code>â†<code>$mount</code></p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// options.render = render</span>
<span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">with</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token keyword">return</span> <span class="token function">_c</span><span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">,</span><span class="token punctuation">{</span>attrs<span class="token operator">:</span><span class="token punctuation">{</span><span class="token string">&quot;id&quot;</span><span class="token operator">:</span><span class="token string">&quot;app&quot;</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">[</span><span class="token function">_c</span><span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">,</span><span class="token punctuation">[</span><span class="token function">_c</span><span class="token punctuation">(</span><span class="token string">'input'</span><span class="token punctuation">,</span><span class="token punctuation">{</span>directives<span class="token operator">:</span><span class="token punctuation">[</span><span class="token punctuation">{</span>name<span class="token operator">:</span><span class="token string">&quot;model&quot;</span><span class="token punctuation">,</span>rawName<span class="token operator">:</span><span class="token string">&quot;v-model&quot;</span><span class="token punctuation">,</span>value<span class="token operator">:</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">,</span>expression<span class="token operator">:</span><span class="token string">&quot;name&quot;</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">,</span>attrs<span class="token operator">:</span><span class="token punctuation">{</span><span class="token string">&quot;type&quot;</span><span class="token operator">:</span><span class="token string">&quot;text&quot;</span><span class="token punctuation">}</span><span class="token punctuation">,</span>domProps<span class="token operator">:</span><span class="token punctuation">{</span><span class="token string">&quot;value&quot;</span><span class="token operator">:</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">,</span>on<span class="token operator">:</span><span class="token punctuation">{</span><span class="token string">&quot;input&quot;</span><span class="token operator">:</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">$event</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token keyword">if</span><span class="token punctuation">(</span>$event<span class="token punctuation">.</span>target<span class="token punctuation">.</span>composing<span class="token punctuation">)</span><span class="token keyword">return</span><span class="token punctuation">;</span>name<span class="token operator">=</span>$event<span class="token punctuation">.</span>target<span class="token punctuation">.</span>value<span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token function">_v</span><span class="token punctuation">(</span><span class="token string">&quot; &quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token function">_c</span><span class="token punctuation">(</span><span class="token string">'my-button'</span><span class="token punctuation">,</span><span class="token punctuation">{</span>attrs<span class="token operator">:</span><span class="token punctuation">{</span><span class="token string">&quot;text&quot;</span><span class="token operator">:</span><span class="token string">&quot;æ·»åŠ &quot;</span><span class="token punctuation">}</span><span class="token punctuation">,</span>on<span class="token operator">:</span><span class="token punctuation">{</span><span class="token string">&quot;click&quot;</span><span class="token operator">:</span>add<span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token function">_v</span><span class="token punctuation">(</span><span class="token string">&quot; &quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token function">_c</span><span class="token punctuation">(</span><span class="token string">'ul'</span><span class="token punctuation">,</span><span class="token function">_l</span><span class="token punctuation">(</span><span class="token punctuation">(</span>showList<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">item<span class="token punctuation">,</span>i</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token keyword">return</span> <span class="token function">_c</span><span class="token punctuation">(</span><span class="token string">'li'</span><span class="token punctuation">,</span><span class="token punctuation">{</span>key<span class="token operator">:</span>i<span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">[</span><span class="token function">_c</span><span class="token punctuation">(</span><span class="token string">'input'</span><span class="token punctuation">,</span><span class="token punctuation">{</span>attrs<span class="token operator">:</span><span class="token punctuation">{</span><span class="token string">&quot;type&quot;</span><span class="token operator">:</span><span class="token string">&quot;checkbox&quot;</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token function">_v</span><span class="token punctuation">(</span><span class="token string">&quot; &quot;</span><span class="token operator">+</span><span class="token function">_s</span><span class="token punctuation">(</span>item<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">&quot;\n        &quot;</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>é¦–æ¬¡æ¸²æŸ“è°ƒç”¨æ ˆ<code>createElm</code>â†<code>patch</code>â†<code>vm.__patch__</code>â†<code>vm._update</code>â†<code>mountComponent</code>â†<code>vm.$mount</code></p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// https://github.com/vuejs/vue/blob/v2.6.11/src/core/instance/lifecycle.js#L197</span>
<span class="token function-variable function">updateComponent</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  vm<span class="token punctuation">.</span><span class="token function">_update</span><span class="token punctuation">(</span>vm<span class="token punctuation">.</span><span class="token function">_render</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> hydrating<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">new</span> <span class="token class-name">Watcher</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> updateComponent<span class="token punctuation">,</span> noop<span class="token punctuation">,</span> <span class="token punctuation">{</span>
  <span class="token function">before</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>vm<span class="token punctuation">.</span>_isMounted <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>vm<span class="token punctuation">.</span>_isDestroyed<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">callHook</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> <span class="token string">'beforeUpdate'</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token boolean">true</span> <span class="token comment">/* isRenderWatcher */</span><span class="token punctuation">)</span>
</code></pre></div><p>å®ä¾‹åŒ–ä¸€ä¸ªæ¸²æŸ“watcherï¼Œåœ¨<code>get</code>å†…æ‰§è¡Œwatcher getter ä¹Ÿå°±æ˜¯updateComponentã€‚</p> <p>å…³é”®çš„ä¸€ä¸ªç‚¹ï¼Œæ‰§è¡Œ<code>pushTarget(this)</code>ï¼Œå°†æ¸²æŸ“watcher å‚¨å­˜åˆ°å…¨å±€Dep.targetã€‚</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">pushTarget</span> <span class="token punctuation">(</span><span class="token parameter">target<span class="token operator">:</span> <span class="token operator">?</span>Watcher</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  targetStack<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span>
  Dep<span class="token punctuation">.</span>target <span class="token operator">=</span> target
<span class="token punctuation">}</span>
</code></pre></div><p>æ‰§è¡Œ<code>vm._render()</code>ï¼Œé€’å½’ç”ŸæˆVNode Treeã€‚</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// https://github.com/vuejs/vue/blob/v2.6.11/src/core/instance/render.js#L91</span>
vnode <span class="token operator">=</span> <span class="token function">render</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>vm<span class="token punctuation">.</span>_renderProxy<span class="token punctuation">,</span> vm<span class="token punctuation">.</span>$createElement<span class="token punctuation">)</span>
</code></pre></div><p>render å°±æ˜¯ç»è¿‡ç¼–è¯‘å¾—åˆ°çš„åŒ¿åå‡½æ•°ï¼Œæ‰§è¡Œå‡½æ•°ï¼Œæ­¤æ—¶è·å–dataå±æ€§ï¼Œè§¦å‘å±æ€§çš„getterï¼Œæ­¤æ•°æ®å°±æ”¶é›†äº†è®¢é˜…è€…æ¸²æŸ“watcherï¼Œè¿™ä¸ªè¿‡ç¨‹ä¹Ÿå°±æ˜¯ä¾èµ–æ”¶é›†ã€‚</p> <p>å½“æ¸²æŸ“æ¨¡ç‰ˆè¯»å–computed æ—¶ï¼Œè§¦å‘getterï¼Œæ‰§è¡Œå›è°ƒï¼Œæ­¤æ—¶<code>watcher.dirty</code>ä¸º<code>true</code>ï¼Œæ‰§è¡Œ<code>watcher.evaluate()</code>ï¼Œå…ˆæ‰§è¡Œ<code>pushTarget(this)</code>ï¼Œè¿™æ—¶å…¨å±€Dep.target æŒ‡å‘computed watcherã€‚åˆè§¦å‘äº†data.list çš„getterï¼Œæ­¤æ—¶data.list çš„æ”¶é›†å™¨å°±èƒ½æ”¶é›†åˆ°computed watcherï¼Œä¸”computed watcher çš„depsä¹Ÿä¿å­˜æœ‰ data.list çš„ä¾èµ–æ”¶é›†å™¨ depã€‚</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// data.list.getter() â† computedWatcher.get() â† computedWatcher.evaluate()</span>
targetStack <span class="token operator">=</span> <span class="token punctuation">[</span>renderWatcher<span class="token punctuation">,</span> computendWatcher<span class="token punctuation">]</span>
Dep<span class="token punctuation">.</span>target <span class="token operator">=</span> computedWatcher

dataListDep <span class="token operator">=</span> <span class="token punctuation">{</span> subs<span class="token operator">:</span> <span class="token punctuation">[</span>computed watcher<span class="token punctuation">]</span> <span class="token punctuation">}</span>
computedWatcher <span class="token operator">=</span> <span class="token punctuation">{</span> deps<span class="token operator">:</span> <span class="token punctuation">[</span>dataListDep<span class="token punctuation">]</span> <span class="token punctuation">}</span>

<span class="token comment">// popTarget</span>
targetStack <span class="token operator">=</span> <span class="token punctuation">[</span>renderWatcher<span class="token punctuation">]</span>
Dep<span class="token punctuation">.</span>target <span class="token operator">=</span> renderWatcher

computedWatcher<span class="token punctuation">.</span>dirty <span class="token operator">=</span> <span class="token boolean">false</span>
</code></pre></div><p>æ¥ç€æ‰§è¡Œ<code>watcher.depend()</code>ï¼Œdata.list çš„æ”¶é›†å™¨å°±èƒ½æ”¶é›†åˆ°æ¸²æŸ“watcherã€‚</p> <div class="language- extra-class"><pre class="language-text"><code>// dep.addSub() â† Dep.target.addDep() â† dep.depend() â† watcher.depend()
// éå†computedWatcher = { deps: [dataListDep] }
// æ‰§è¡ŒdataListDep.depend()
// æ‰§è¡ŒDep.target.addDep(this)
// æ‰§è¡ŒdataListDep.addSub(this)
dataListDep = { subs: [computedWatcher, renderWatcher] }
</code></pre></div><p>æ‰§è¡Œ<code>vm._update</code>ï¼Œé€’å½’éå†<code>createElm</code>ï¼Œé€šè¿‡å…ˆå­åçˆ¶çš„æ’å…¥é¡ºåºå°†Vnode æ¸²æŸ“æˆDOMã€‚</p> <p>å¦‚æœæ˜¯ç»„ä»¶ï¼Œä¼šèµ°<code>createComponent</code></p> <p>åˆ›å»ºç»„ä»¶è°ƒç”¨æ ˆ<code>updateComponent</code>â†<code>Vue.$mount</code>â†<code>Vue._init</code>â†<code>new Vue.extend(options)</code>â†<code>createComponentInstanceForVnode</code>â†<code>init</code>â†<code>createComponent</code></p> <p>åˆå›åˆ°æ¸²æŸ“è°ƒç”¨æ ˆã€‚æœ€åæŒ‚è½½åˆ°#appçš„çˆ¶èŠ‚ç‚¹å³bodyä¸Šï¼Œå†ç§»é™¤æ—§èŠ‚ç‚¹ã€‚</p> <h5 id="äº‹ä»¶ç»‘å®š"><a href="#äº‹ä»¶ç»‘å®š" class="header-anchor">#</a> äº‹ä»¶ç»‘å®š</h5> <p><code>patch</code>æ˜¯<code>createPatchFunction</code>æŸ¯é‡ŒåŒ–è¿”å›çš„å‡½æ•°ï¼Œé€šè¿‡æŸ¯é‡ŒåŒ–æŠ¹å¹³å¹³å°å·®å¼‚ï¼Œæ— é¡»æ²¡æ¬¡è°ƒç”¨ä¼ å…¥å‚æ•°ã€‚</p> <p>é™¤æ­¤ä¹‹å¤–ï¼Œè¿˜å°†å…ƒç´ çš„é’©å­å‡½æ•°èšåˆåœ¨ä¸€èµ·ã€‚å…ƒç´ äº‹ä»¶ï¼Œå±æ€§ï¼Œæ ·å¼çš„è®¾ç½®æ›´æ–°éƒ½æ˜¯é€šè¿‡è¿™äº›é’©å­å®Œæˆã€‚</p> <p>æœ¬æ–‡è·³è¿‡v-model çš„å®ç°ï¼Œé‡ç‚¹åœ¨clickã€‚</p> <h6 id="è‡ªå®šä¹‰äº‹ä»¶"><a href="#è‡ªå®šä¹‰äº‹ä»¶" class="header-anchor">#</a> è‡ªå®šä¹‰äº‹ä»¶</h6> <p>åœ¨æ„é€ ç»„ä»¶VNodeçš„æ—¶å€™ï¼Œä¼šæŠŠæ–°å»ºä¸€ä¸ªå‚æ•°listenersï¼ŒæŒ‡å‘data.onï¼Œå¹¶ä½œä¸ºoptions å±æ€§ï¼Œå»å®ä¾‹åŒ–VNodeã€‚</p> <p>åœ¨ç»„ä»¶æ¸²æŸ“æˆdomè¿›è¡Œç»„ä»¶åˆå§‹åŒ–çš„æ—¶å€™ï¼Œè°ƒç”¨åˆå§‹åŒ–äº‹ä»¶ä¸­å¿ƒï¼Œå°†è‡ªå®šä¹‰äº‹ä»¶ä¼ é€’ç»™å­ç»„ä»¶å®ä¾‹ï¼Œå­˜å‚¨åœ¨<code>vm._events</code>ã€‚</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// createComponent â† createElement() â† vm._render()</span>
listeners <span class="token operator">=</span> data<span class="token punctuation">.</span>on <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token string">&quot;click&quot;</span><span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>add <span class="token punctuation">}</span>
componentVnode<span class="token punctuation">.</span>componentOptions<span class="token punctuation">.</span>listeners <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token string">&quot;click&quot;</span><span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>add <span class="token punctuation">}</span>

<span class="token comment">//  updateListeners() ... â† initEvent() â† Vue._init() â† ... â† createComponent â† ... â† vm._update()</span>
<span class="token comment">// createComponentInstanceForVnode</span>
<span class="token keyword">new</span> <span class="token class-name">vnode<span class="token punctuation">.</span>componentOptions<span class="token punctuation">.</span>Ctor</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token operator">...</span><span class="token punctuation">,</span> _parentVnode<span class="token operator">:</span> vnode <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token comment">// initInternalComponent</span>
vm<span class="token punctuation">.</span>$options<span class="token punctuation">.</span>_parentListeners <span class="token operator">=</span> options<span class="token punctuation">.</span>_parentVnode<span class="token punctuation">.</span>componentOptions<span class="token punctuation">.</span>listeners
<span class="token comment">// initEvents</span>
<span class="token function">updateComponentListeners</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> listeners<span class="token punctuation">)</span>
<span class="token comment">// ...</span>
vm<span class="token punctuation">.</span><span class="token function">$on</span><span class="token punctuation">(</span><span class="token string">'click'</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>add<span class="token punctuation">)</span>
<span class="token comment">// ...</span>
vm<span class="token punctuation">.</span>_events<span class="token punctuation">[</span><span class="token string">'click'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token keyword">this</span><span class="token punctuation">.</span>add<span class="token punctuation">]</span>
</code></pre></div><h6 id="dom-äº‹ä»¶ç»‘å®š"><a href="#dom-äº‹ä»¶ç»‘å®š" class="header-anchor">#</a> dom äº‹ä»¶ç»‘å®š</h6> <p>åœ¨<code>patch</code>è¿‡ç¨‹è§¦å‘å…ƒç´ çš„é’©å­å‡½æ•°<code>create</code>ï¼Œè¿›è¡Œäº‹ä»¶çš„ç»‘å®šã€‚</p> <p>åœ¨dom æ’å…¥çˆ¶èŠ‚ç‚¹å‰ä¼šæ‰§è¡Œ<code>invokeCreateHooks</code>ã€‚</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// updateListeners â† updateDOMListeners â† invokeCreateHooks(vnode, insertedVnodeQueue)</span>
vnode<span class="token punctuation">.</span>elm<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'click'</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">$emit</span><span class="token punctuation">(</span><span class="token string">'click'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h4 id="æ›´æ–°"><a href="#æ›´æ–°" class="header-anchor">#</a> æ›´æ–°</h4> <p>ç°åœ¨åˆ†æï¼Œå‹¾é€‰ææ–¯ï¼Œè¾“å…¥æ¡†è¾“å…¥å¼ ä¸‰ï¼Œç‚¹å‡»buttonï¼Œè¿™ä¸ªæ›´æ–°è¿‡ç¨‹ã€‚</p> <p>æ¶‰åŠv-modelï¼Œç®€å•ä»‹ç»ä¸€ä¸‹ã€‚å®é™…ä¸Šv-modelæ˜¯ä¸€ä¸ªè¯­æ³•ç³–ï¼Œä¸€ä¸ªæŒ‡ä»¤ï¼Œåœ¨ç¼–è¯‘è¿‡ç¨‹ï¼Œé’ˆå¯¹ä¸åŒæ ‡ç­¾ç”Ÿæˆä¸åŒäº‹ä»¶å’Œå±æ€§ï¼Œé€šè¿‡composing ç»†èŠ‚å¤„ç†æ··åˆè¾“å…¥æ³•çš„æŠ¬æ‰‹é—®é¢˜ã€‚ä¾‹å¦‚<code>&lt;input type=&quot;radio&quot; /&gt;</code>ç”Ÿæˆchange äº‹ä»¶å’Œ checked å±æ€§ï¼Œ<code>&lt;input type=&quot;text&quot; /&gt;</code>ç”Ÿæˆ input äº‹ä»¶å’Œ value å±æ€§ã€‚ è¿™å°±æ˜¯Vueçš„åŒå‘ç»‘å®šåŸç†ã€‚</p> <p>å½“ç‚¹å‡»buttonï¼Œè§¦å‘click å›è°ƒï¼Œé€šè¿‡<code>MyButton.$emit('click')</code>æ´¾å‘äº‹ä»¶ï¼Œæ‰§è¡Œ<code>MyButton._event['click']</code>å­˜å‚¨çš„æ‰€æœ‰å‡½æ•°ã€‚è¿™æ—¶å®šä¹‰åœ¨çˆ¶ç»„ä»¶çš„<code>add</code>è¢«è§¦å‘ï¼Œæ‰§è¡Œ<code>this.list.unshift</code>ï¼Œè§¦å‘Vue å­å®šä¹‰çš„æ–¹æ³•ï¼Œæ‰§è¡Œ<code>dataList.__ob__.dep.notify()</code>ï¼Œè§¦å‘è®¢é˜…è€…æ›´æ–°ã€‚</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token punctuation">[</span>computedWatcher<span class="token punctuation">,</span> renderWatcher<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">sub</span> <span class="token operator">=&gt;</span> sub<span class="token punctuation">.</span>update<span class="token punctuation">)</span>
<span class="token comment">// computedWatcher.update()</span>
computedWatcher<span class="token punctuation">.</span>dirty <span class="token operator">=</span> <span class="token boolean">true</span>

<span class="token comment">// renderWatcher.update()</span>
<span class="token function">queueWatcher</span><span class="token punctuation">(</span>renderWatcher<span class="token punctuation">)</span>

<span class="token keyword">function</span> <span class="token function">queueWatcher</span><span class="token punctuation">(</span><span class="token parameter">watcher</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>has<span class="token punctuation">[</span>id<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token operator">...</span>
    queue<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>watcher<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">// è¿™é‡Œæ¶‰åŠæ›´æ–°é˜Ÿåˆ—ä¼˜åŒ–ï¼Œæ¯”å¦‚ï¼Œåœ¨è¿™ä¸ªä¾‹å­ä¸­</span>
<span class="token comment">// this.list.unshift ä¼šè§¦å‘renderWatcher.update</span>
<span class="token comment">// this.name = '' ä¹Ÿä¼šè§¦å‘renderWatcher.update</span>
<span class="token comment">// åŒä¸€ä¸ªrenderWatcherï¼Œæ‰€ä»¥åªä¼šæ·»åŠ ä¸€æ¬¡</span>
queue <span class="token operator">=</span> <span class="token punctuation">[</span>renderWatcher<span class="token punctuation">]</span>

<span class="token function">nextTick</span><span class="token punctuation">(</span>flushSchedulerQueue<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// ä½¿ç”¨nextTickï¼Œæ›´æ–°é˜Ÿåˆ—å°†åœ¨ä¸‹ä¸€ä¸ªTickæ‰§è¡Œ</span>
<span class="token comment">// ä¸‹ä¸€ä¸ªTickå°±æ˜¯å½“ä¸»çº¿ç¨‹ä¸ºç©ºï¼Œä»ä»»åŠ¡é˜Ÿåˆ—è¯»å–ä»»åŠ¡åˆ°è°ƒç”¨æ ˆä¸­ç­‰å¾…ä¸»çº¿ç¨‹æ‰§è¡Œã€‚</span>

<span class="token comment">// patchVnode() â† vm.__patch__() â† ... â† vm._update(vm._render(), hydrating)</span>
<span class="token comment">// â† updateComponent()(renderWatcher.getter()) â† renderWatcher.run()</span>
<span class="token comment">// â† flushSchedulerQueue()</span>

<span class="token comment">// åœ¨æ‰§è¡Œvm.render()çš„æ—¶å€™ï¼Œè§¦å‘computed çš„getterï¼Œé‡æ–°è®¡ç®—è¿”å›æ–°å€¼</span>
<span class="token comment">// è¿™ä¸ªè¿‡ç¨‹åˆä¼šè§¦å‘dataList çš„getterï¼Œè¿›è¡Œæ–°ä¸€è·¯çš„ä¾èµ–æ”¶é›†ï¼Œæµç¨‹è¿˜æ˜¯ä¸€æ ·</span>
<span class="token comment">// æ‰€ä»¥è¯´computed æ˜¯æƒ°æ€§çš„ï¼ˆç¼“å­˜çš„ï¼‰ï¼Œåªæœ‰çœŸæ­£å»è·å–å€¼çš„æ—¶å€™æ‰ä¼šæ‰§è¡Œè®¡ç®—</span>
</code></pre></div><p>Vue çš„<code>patchVnode</code>é€»è¾‘é€šè¿‡åˆ¤æ–­èŠ‚ç‚¹ç±»å‹è¿›è¡Œæ›´æ–°ï¼š</p> <ol><li>æ–°èŠ‚ç‚¹ä¸ºéæ–‡æœ¬èŠ‚ç‚¹
<ol><li>æ–°æ—§èŠ‚ç‚¹éƒ½æœ‰children &amp;&amp; ä¸¤è€…ä¸ç›¸ç­‰ï¼ŒupdateChildren</li> <li>åªæœ‰æ–°èŠ‚ç‚¹æœ‰childrenï¼Œæ—§èŠ‚ç‚¹ä¸ºæ–‡æœ¬å…ˆæ¸…ç©ºï¼Œå†æ–°å¢children</li> <li>åªæœ‰æ—§èŠ‚ç‚¹æœ‰childrenï¼Œç§»é™¤æ—§èŠ‚ç‚¹children</li> <li>æ—§èŠ‚ç‚¹åªæœ‰æ–‡æœ¬èŠ‚ç‚¹ï¼Œæ¸…ç©ºæ–‡æœ¬å†…å®¹</li></ol></li> <li>æ–°èŠ‚ç‚¹ä¸ºæ–‡æœ¬èŠ‚ç‚¹ &amp;&amp; ä¸æ—§èŠ‚ç‚¹ä¸ç›¸ç­‰ï¼Œåˆ™ç”¨æ–‡æœ¬æ›¿æ¢æ—§èŠ‚ç‚¹å†…å®¹</li></ol> <p>é€šè¿‡é€’å½’çš„æ–¹å¼å®Œæˆæ•´æ£µVNode æ ‘çš„æ›´æ–°ã€‚</p> <p>ä»¥updateCHildren ä¸ºä¸»çº¿ï¼Œåˆ†ækey çš„ä½œç”¨ã€‚</p> <p>å½“å¯¹ul æ–°æ—§VNode è¿›è¡Œæ¯”å¯¹æ—¶ï¼Œå»åˆ°updateChildren åˆ†æ”¯ï¼Œé€šè¿‡ä¼ªä»£ç çš„å½¢å¼åˆ†æã€‚</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>VNode<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span> tag<span class="token operator">:</span> <span class="token string">'li'</span><span class="token punctuation">,</span> key<span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span> children<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span> tag<span class="token operator">:</span> <span class="token string">'input'</span><span class="token punctuation">,</span> elm<span class="token operator">:</span> <span class="token punctuation">{</span> value<span class="token operator">:</span> <span class="token string">'on'</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> text<span class="token operator">:</span> <span class="token string">'ææ–¯'</span> <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token operator">...</span><span class="token punctuation">]</span>
newVNode<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span> tag<span class="token operator">:</span> <span class="token string">'li'</span><span class="token punctuation">,</span> key<span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span> children<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span> tag<span class="token operator">:</span> <span class="token string">'input'</span><span class="token operator">:</span> elm<span class="token operator">:</span> <span class="token keyword">undefined</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> text<span class="token operator">:</span> <span class="token string">'å¼ ä¸‰'</span> <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token operator">...</span><span class="token punctuation">]</span>

<span class="token comment">// å½“å¯¹æ–°æ—§liVnode æ¯”å¯¹æ—¶ï¼Œåˆ¤æ–­key tag ç›¸ç­‰ï¼ŒpatchVnode(inputVNode, newInputVNode)</span>
<span class="token comment">// å½“å¯¹æ–°æ—§inputVnode æ¯”å¯¹æ—¶ï¼Œåˆ¤æ–­key tag inputType ç›¸ç­‰ï¼ŒpatchVnodeï¼Œå¤ç”¨èŠ‚ç‚¹ï¼Œé€ æˆé”™è¯¯æ¸²æŸ“</span>
<span class="token keyword">var</span> elm <span class="token operator">=</span> vnode<span class="token punctuation">.</span>elm <span class="token operator">=</span> oldVnode<span class="token punctuation">.</span>elm<span class="token punctuation">;</span>

<span class="token comment">// æŠŠæ¨¡ç‰ˆli æ ‡ç­¾çš„id æ›´æ¢ä¸ºitem.id</span>
VNode<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span> tag<span class="token operator">:</span> <span class="token string">'li'</span><span class="token punctuation">,</span> key<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span> children<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span> tag<span class="token operator">:</span> <span class="token string">'input'</span><span class="token punctuation">,</span> elm<span class="token operator">:</span> <span class="token punctuation">{</span> value<span class="token operator">:</span> <span class="token string">'on'</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> text<span class="token operator">:</span> <span class="token string">'ææ–¯'</span> <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token operator">...</span><span class="token punctuation">]</span>
newVNode<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span> tag<span class="token operator">:</span> <span class="token string">'li'</span><span class="token punctuation">,</span> key<span class="token operator">:</span> <span class="token number">4</span><span class="token punctuation">,</span> children<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span> tag<span class="token operator">:</span> <span class="token string">'input'</span><span class="token operator">:</span> elm<span class="token operator">:</span> <span class="token keyword">undefined</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> text<span class="token operator">:</span> <span class="token string">'å¼ ä¸‰'</span> <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> tag<span class="token operator">:</span> <span class="token string">'li'</span><span class="token punctuation">,</span> key<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span> children<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span> tag<span class="token operator">:</span> <span class="token string">'input'</span><span class="token punctuation">,</span> elm<span class="token operator">:</span> <span class="token punctuation">{</span> value<span class="token operator">:</span> <span class="token string">'on'</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> text<span class="token operator">:</span> <span class="token string">'ææ–¯'</span> <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token operator">...</span><span class="token punctuation">]</span>
<span class="token comment">// ç®€åŒ–ä¸€ä¸‹</span>
VNode<span class="token operator">:</span> <span class="token punctuation">[</span>a<span class="token punctuation">,</span> b<span class="token punctuation">,</span> c<span class="token punctuation">]</span>
newVNode<span class="token operator">:</span> <span class="token punctuation">[</span>d<span class="token punctuation">,</span> a<span class="token punctuation">,</span> b<span class="token punctuation">,</span> c<span class="token punctuation">]</span>
oldStartIdx <span class="token operator">=</span> <span class="token number">0</span>
newStartIdx <span class="token operator">=</span> <span class="token number">0</span>
oldEndIdx <span class="token operator">=</span> <span class="token number">2</span>
newEndIdx <span class="token operator">=</span> <span class="token number">3</span>
oldStartVnode <span class="token operator">=</span> a
oldEndVnode <span class="token operator">=</span> c
newStartVnode <span class="token operator">=</span> d
newEndVnode <span class="token operator">=</span> c

<span class="token keyword">while</span> <span class="token punctuation">(</span>oldStartIdx <span class="token operator">&lt;=</span> oldEndIdx <span class="token operator">&amp;&amp;</span> newStartIdx <span class="token operator">&lt;=</span> newEndIdx<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// è¿›è¡Œé¦–é¦–å¯¹æ¯”same(a, d)ä¸ç¬¦åˆï¼Œè¿›è¡Œå°¾å°¾å¯¹æ¯”same(c, c)ï¼Œå¤ç”¨èŠ‚ç‚¹</span>
  oldEndIdx <span class="token operator">=</span> <span class="token number">1</span>
  oldEndVnode <span class="token operator">=</span> b
  newEndIdx <span class="token operator">=</span> <span class="token number">2</span>
  newEndVnode <span class="token operator">=</span> b
  <span class="token comment">// è¿›è¡Œé¦–é¦–å¯¹æ¯”same(a, d)ä¸ç¬¦åˆï¼Œè¿›è¡Œå°¾å°¾å¯¹æ¯”same(b, b)ï¼Œå¤ç”¨èŠ‚ç‚¹</span>
  oldEndIdx <span class="token operator">=</span> <span class="token number">0</span>
  oldEndVnode <span class="token operator">=</span> a
  newEndIdx <span class="token operator">=</span> <span class="token number">1</span>
  newEndVnode <span class="token operator">=</span> a
  <span class="token comment">// è¿›è¡Œé¦–é¦–å¯¹æ¯”same(a, d)ä¸ç¬¦åˆï¼Œè¿›è¡Œå°¾å°¾å¯¹æ¯”same(a, a)ï¼Œå¤ç”¨èŠ‚ç‚¹</span>
  oldEndIdx <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span>
  oldEndVnode <span class="token operator">=</span> <span class="token keyword">undefined</span>
  newEndIdx <span class="token operator">=</span> <span class="token number">0</span>
  newEndVnode <span class="token operator">=</span> d
<span class="token punctuation">}</span>
newStartIdx <span class="token operator">=</span> <span class="token number">0</span>
newEndIdx <span class="token operator">=</span> <span class="token number">0</span>
<span class="token function">addVnodes</span><span class="token punctuation">(</span>parentElm<span class="token punctuation">,</span> refElm<span class="token punctuation">,</span> newCh<span class="token punctuation">,</span> newStartIdx<span class="token punctuation">,</span> newEndIdx<span class="token punctuation">,</span> insertedVnodeQueue<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// æ»¡è¶³æ¡ä»¶ï¼Œåˆ›å»ºæ–°å…ƒç´ å¹¶æ’å…¥</span>
<span class="token function">createElm</span><span class="token punctuation">(</span>vnodes<span class="token punctuation">[</span>startIdx<span class="token punctuation">]</span><span class="token punctuation">,</span> insertedVnodeQueue<span class="token punctuation">,</span> parentElm<span class="token punctuation">,</span> refElm<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> vnodes<span class="token punctuation">,</span> startIdx<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h4 id="æ€»ç»“"><a href="#æ€»ç»“" class="header-anchor">#</a> æ€»ç»“</h4> <p>æ­¤æ¬¡æ¢³ç†åªæ˜¯é’ˆå¯¹ä¾‹å­ï¼Œæ•´ä½“æµç¨‹èµ°äº†ä¸€éï¼Œå¾ˆå¤šç»†èŠ‚ä¸Šçš„å†…å®¹å¹¶æ²¡æœ‰å±•å¼€ï¼Œæ„Ÿå…´è¶£å¯ä»¥é’ˆå¯¹æŸä¸€æ¨¡å—è¿›è¡Œå•æ­¥è°ƒè¯•åŠ æ·±ç†è§£ã€‚</p> <p>é€šè¿‡ä»¥ä¸Šæµç¨‹å¯ä»¥æ¢³ç†å‡ºå‡ ä¸ªçŸ¥è¯†ç‚¹ï¼š</p> <ol><li>computed å®é™…ä¸Šæ˜¯ä¸€ä¸ªcomputedWatcherï¼Œä½œä¸ºdata å’Œ æ¸²æŸ“Watcher çš„æ¡¥æ¢ï¼Œä½¿å¾—æ¸²æŸ“Watcher èƒ½å¤Ÿé—´æ¥è®¢é˜…dataã€‚</li> <li>key ä½œä¸ºVNode çš„å”¯ä¸€æ ‡è¯†ï¼Œç¡®ä¿å…ƒç´ å¯ä»¥å¤ç”¨è‡ªèº«çŠ¶æ€ï¼Œé¿å…å‘ç”Ÿé”™è¯¯æ¸²æŸ“ï¼Œæ¶‰åŠä¾èµ–çŠ¶æ€çš„éƒ½å¿…é¡»ä½¿ç”¨é™æ€keyã€‚é™¤éæ¸²æŸ“ä¸€äº›ç®€å•ç±»å‹çš„å†…å®¹ï¼Œåˆ»æ„åˆ©ç”¨Vue å†…éƒ¨çš„ç®—æ³•ä»¥è¾¾åˆ°æ€§èƒ½çš„æå‡ã€‚å¦å¤–çš„ï¼Œåœ¨ä¸€äº›å¤æ‚çš„åˆ—è¡¨åœºæ™¯ï¼Œä¸èƒ½å‘½ä¸­é¦–å°¾äº¤å‰æ¯”å¯¹çš„æƒ…å†µä¸‹ï¼ŒVue ä¼šæ ¹æ®oldChildren çš„keyç”Ÿæˆkey-index çš„å¯¹è±¡ï¼Œå¯ä»¥æ ¹æ®newStartVnode çš„key æ‰¾åˆ°ä¸ä¹‹å¯¹åº”çš„ oldVNodeï¼Œç›¸å¯¹éå†oldChildren å†æ¯”å¯¹ï¼Œæ€§èƒ½è¾ƒä¼˜ã€‚</li> <li>åŸç”Ÿäº‹ä»¶æ˜¯é€šè¿‡addEventListener æ³¨å†Œï¼Œè‡ªå®šä¹‰äº‹ä»¶ç”±çˆ¶ç»„ä»¶ä¼ é€’ç»™å­ç»„ä»¶å®ä¾‹å‚¨å­˜ï¼Œé€šè¿‡å‘å¸ƒè®¢é˜…çš„æ¨¡å¼å®ç°ã€‚</li></ol></div> <footer><!----> <hr> <!----></footer></article> <!----></div></div> <footer class="footer" data-v-582f9766><div class="footer-left-wrap" data-v-582f9766><ul class="contact" data-v-582f9766><li class="contact-item" data-v-582f9766><a href="https://github.com/zhangjanp" target="_blank" rel="noopener noreferrer" class="nav-link external" data-v-582f9766><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-github" data-v-582f9766><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22" data-v-582f9766></path></svg>
          
        </a></li><li class="contact-item" data-v-582f9766><a href="mailto:zhang_janp@163.com" class="nav-link external" data-v-582f9766><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-mail" data-v-582f9766><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z" data-v-582f9766></path><polyline points="22,6 12,13 2,6" data-v-582f9766></polyline></svg>
          
        </a></li></ul></div> <div class="footer-right-wrap" data-v-582f9766><ul class="copyright" data-v-582f9766><li class="copyright-item" data-v-582f9766><a href="/blog/2020/03/23/%E4%BB%A5%E4%B8%80%E4%B8%AA%F0%9F%8C%B0%E6%A2%B3%E7%90%86vue-%E6%9B%B4%E6%96%B0%E6%B5%81%E7%A8%8B/" class="nav-link router-link-exact-active router-link-active" data-v-582f9766>Janp Â© 2020</a></li></ul></div></footer></div><div class="global-ui"></div></div>
    <script src="/blog/assets/js/app.5776ca6d.js" defer></script><script src="/blog/assets/js/7.97f44f77.js" defer></script><script src="/blog/assets/js/4.3aa6202f.js" defer></script><script src="/blog/assets/js/15.b29bc2a4.js" defer></script>
  </body>
</html>
